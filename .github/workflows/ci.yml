name: CI

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Detect Unity project
        id: unity
        run: |
          if [ -f "Assets/ProjectSettings/ProjectVersion.txt" ]; then
            echo "unity=true" >> $GITHUB_OUTPUT
          else
            echo "unity=false" >> $GITHUB_OUTPUT
          fi

      - name: Restore/Build/Test using Braziliation.sln (if not Unity)
        if: steps.unity.outputs.unity != 'true'
        run: |
          if [ -f "Braziliation.sln" ]; then
            if grep -q "Assembly-CSharp.csproj" Braziliation.sln; then
              echo "Detected Unity solution (Assembly-CSharp) — skipping .NET build."
            else
              echo "Using Braziliation.sln — restoring..."
              dotnet restore Braziliation.sln
              echo "Building solution..."
              dotnet build Braziliation.sln --configuration Release --no-restore
              echo "Running tests (if present)..."
              dotnet test Braziliation.sln --no-build --verbosity normal || true
            fi
          else
            echo "Braziliation.sln not found — skipping dotnet steps."
          fi

      - name: Skip dotnet for Unity
        if: steps.unity.outputs.unity == 'true'
        run: |
          echo "Unity project detected — skipping dotnet restore/build/test."

      - name: Post-check
        run: echo "CI completed."